# === Global shared persistence ===
persistence:
  enabled: true
  storageClass: &storageClass longhorn
  accessMode: ReadWriteMany
  volumes:
    modelWeights: { size: 50Gi }
    data: { size: 20Gi }
    hydraConfig: { size: 10Mi }
    logs: { size: 1Gi }
    venv: { size: 10Gi }

ray:
  workers:
    count: 2
    replicas: 1
    minReplicas: 1
    maxReplicas: 1
  image:
    repository: ghcr.io/linagora/openrag-ray
    tag: latest

# === PostgreSQL (bitnami) ===
postgresql:
  enabled: true
  auth:
    username: &pgUser root
    password: &pgPass root_password
  primary:
    persistence:
      enabled: true
      size: 10Gi
      storageClass: *storageClass
  service:
    port: &pgPort 5432

# === Milvus ===
milvus:
  enabled: true
  image:
    all: { tag: v2.6.0 }
  cluster: { enabled: true }
  pulsarv3: { enabled: false }
  woodpecker: { enabled: true }
  streaming: { enabled: true }
  indexNode: { enabled: false }
  minio:
    mode: distributed
    replicas: 4
    persistence:
      enabled: true
      size: 20Gi
      storageClass: *storageClass
  etcd:
    replicaCount: 3
    persistence:
      enabled: true
      size: 10Gi
      storageClass: *storageClass
  proxy:
    service:
      type: ClusterIP
      port: 19530

# === vLLM (embedder) ===
vllm:
  embedderModelName: &embedderModel "Qwen/Qwen3-Embedding-0.6B"
  servingEngineSpec:
    enableEngine: true
    modelSpec:
      - name: "embedder"
        repository: "vllm/vllm-openai"
        tag: "latest"
        modelURL: *embedderModel
        replicaCount: 1
        requestCPU: 4
        requestMemory: "16Gi"
        requestGPU: 1
        limitCPU: 4
        limitMemory: "16Gi"
        hf_token:
          secretName: rag-env-secrets
          secretKey: HF_TOKEN
        vllmConfig:
          gpuMemoryUtilization: 0.3
          extraArgs: ["--trust-remote-code", "--task", "embed"]
    servicePort: &vllmPort 8000

# === Infinity reranker ===
reranker:
  rerankerModelName: &rerankerModel "Alibaba-NLP/gte-multilingual-reranker-base"
  servicePort: &rerankerPort 7997
  image:
    repository: michaelf34/infinity
    tag: latest
  model:
    id: Alibaba-NLP/gte-multilingual-reranker-base
  command:
    - v2
    - --model-id
    - *rerankerModel
    - --port
    - *rerankerPort
  replicas: 1
  runtimeClassName: nvidia
  service:
    type: ClusterIP
    port: *rerankerPort
  resources:
    requests:
      cpu: "4"
      memory: "16Gi"
    limits:
      cpu: "4"
      memory: "16Gi"
# === OpenRAG main app ===
openrag:
  image:
    repository: ghcr.io/linagora/openrag
    tag: latest
  service:
    type: ClusterIP
    port: 8080
  resources:
    requests:
      cpu: "4"
      memory: "16Gi"
    limits:
      cpu: "4"
      memory: "16Gi"
  replicas: 1

ingress:
  enabled: true
  className: "nginx"
  host: ""

  paths:
    openrag:
      enabled: true

# === Shared env (config + secrets) ===
env:
  config:
    # LLM
    BASE_URL: "https://example.com/v1/"
    MODEL: "Mistral-Small-3.1-24B-Instruct-2503"
    LLM_SEMAPHORE: "50"

    # VLM
    VLM_BASE_URL: "https://example.com/v1/"
    VLM_MODEL: "Qwen2.5-VL-7B-Instruct"
    VLM_SEMAPHORE: "50"

    # App
    APP_PORT: "8080"
    APP_HOST: "0.0.0.0"
    ENABLE_RAY_SERVE: "true"
    RAY_SERVE_NUM_REPLICAS: "4"
    RAY_SERVE_PORT: "80"

    WITH_CHAINLIT_UI: "false"
    SAVE_UPLOADED_FILES: "false"
    API_NUM_WORKERS: "8"
    INDEXERUI_URL: "http://indexer-ui:3042"

    # Vector DB
    VDB_HOST: "{{ .Release.Name }}-milvus"
    VDB_PORT: "19530"
    VDB_CONNECTOR_NAME: "milvus"

    # PostgreSQL
    POSTGRES_HOST: "{{ .Release.Name }}-postgresql"
    POSTGRES_PORT: *pgPort
    POSTGRES_USER: *pgUser
    POSTGRES_PASSWORD: *pgPass

    # Retriever
    CONTEXTUAL_RETRIEVAL: "true"
    RETRIEVER_TOP_K: "15"

    # Embedder
    EMBEDDER_MODEL_NAME: *embedderModel
    EMBEDDER_BASE_URL: "http://{{ .Release.Name }}-embedder-engine-service:{{ .Values.vllm.servingEngineSpec.servicePort }}/v1"

    # Reranker
    RERANKER_MODEL: *rerankerModel
    RERANKER_ENABLED: "true"
    RERANKER_TOP_K: "4"
    RERANKER_BASE_URL: "http://{{ .Release.Name }}-reranker:{{ .Values.reranker.servicePort }}"
    RERANKER_MODEL_TYPE: "infinity"

    # Prompts
    PROMPTS_DIR: "../prompts/example1"

    # Loaders
    PDFLoader: "MarkerLoader"
    XDG_CACHE_HOME: "/app/model_weights"
    MARKER_MAX_TASKS_PER_CHILD: "10"
    MARKER_MAX_PROCESSES: "15"
    MARKER_MIN_PROCESSES: "3"
    MARKER_POOL_SIZE: "3"
    MARKER_NUM_GPUS: "0.6"

    # Ray
    RAY_NUM_GPUS: "0.1"
    RAY_POOL_SIZE: "3"
    RAY_MAX_TASKS_PER_WORKER: "50"
    RAY_DASHBOARD_PORT: "8265"
    RAY_ADDRESS: "ray://raycluster-head-svc:10001"
    RAY_task_retry_delay_ms: "3000"
    RAY_ENABLE_UV_RUN_RUNTIME_ENV: "0"

    UV_LINK_MODE: "copy"
    UV_CACHE_DIR: "/tmp/uv-cache"

  secrets:
    API_KEY: "sk-xxxx" # LLM API KEY
    VLM_API_KEY: "sk-xxxx" # VLM API KEY
    EMBEDDER_API_KEY: "EMPTY"
    AUTH_TOKEN: "sk-xxxx" # API KEY for OpenRAG
    HF_TOKEN: "hf_xxxx" # HuggingFace token
